#!/usr/bin/env bash
umask 022

set -euo pipefail

###
# Arguments
###
TYPE="${1:-}"
QUERY="${2:-}"

###
# Environment (with sane defaults)
###
REMOTE_USER="
${REMOTE_USER:-user}"
REMOTE_HOST="
${REMOTE_HOST:-your.remote.host}"
REMOTE_BASE="
${REMOTE_BASE:-~/media}"
SSH_KEY_FILE="
${SSH_KEY_FILE:-id_ed25519}"

LOCAL_BASE="/data"
PARTIAL_DIR="$LOCAL_BASE/.rsync-partial"

# Allow override of allowed "types" (comma-separated). Default is "tv,movies"
ALLOWED_TYPES="${ALLOWED_TYPES:-tv,movies}"
# Remove any spaces the user might include
ALLOWED_TYPES="${ALLOWED_TYPES// /}"

###
# Validation
###
if [[ -z "${TYPE}" || -z "${QUERY}" ]]; then
  echo "Usage: rsyncdl {${ALLOWED_TYPES//,/|}} \"Title\""
  exit 1
fi

# Build array from comma-separated ALLOWED_TYPES and perform case-insensitive match
IFS=',' read -ra ALLOWED_ARR <<< "$ALLOWED_TYPES"
TYPE_L="${TYPE,,}"
found=0
for v in "${ALLOWED_ARR[@]}"; do
  v_l="${v,,}"
  if [[ "$v_l" == "$TYPE_L" ]]; then
    found=1
    break
  fi
done

if [[ "$found" -ne 1 ]]; then
  echo "First argument must be one of: ${ALLOWED_TYPES//,/ }"
  exit 1
fi

SSH_KEY_PATH="/config/$SSH_KEY_FILE"

if [[ ! -f "$SSH_KEY_PATH" ]]; then
  echo "SSH key not found: $SSH_KEY_PATH"
  exit 10
fi

###
# Paths
###
REMOTE_DIR="$REMOTE_BASE/$TYPE"
LOCAL_DIR="$LOCAL_BASE/$TYPE"

mkdir -p "$LOCAL_DIR" "$PARTIAL_DIR"

SSH_OPTS="-o StrictHostKeyChecking=no -i $SSH_KEY_PATH"

echo "Searching remote $TYPE for: $QUERY"
echo "Remote: $REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR"
echo "Local : $LOCAL_DIR"
echo "SSH key: $SSH_KEY_FILE"

###
# Fuzzy match (space-insensitive)
###
PATTERN="$(echo "$QUERY" | sed 's/ /.*?/g')"

MATCHES=$(ssh $SSH_OPTS "$REMOTE_USER@$REMOTE_HOST" "cd \"$REMOTE_DIR\" && ls -1" | grep -iE "$PATTERN" || true)

if [[ -z "$MATCHES" ]]; then
  echo "No matches found."
  exit 2
fi

COUNT=$(echo "$MATCHES" | wc -l | tr -d ' ')

if [[ "$COUNT" -gt 1 ]]; then
  echo "Multiple matches found:"
  echo "$MATCHES"
  exit 3
fi

REMOTE_NAME="$MATCHES"

echo "Found: $REMOTE_NAME"
echo "Starting rsync (resumable)..."

rsync -av \
  --partial \
  --append-verify \
  --progress \
  --temp-dir="$PARTIAL_DIR" \
  -e "ssh $SSH_OPTS" \
  "$REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR/$REMOTE_NAME/" \
  "$LOCAL_DIR/$REMOTE_NAME/"